<?php require_once __DIR__ . '/src/auth.php'; require_login(); $user = current_user(); $msg=''; if($_SERVER['REQUEST_METHOD']==='POST' && isset($_FILES['photo']) && $_FILES['photo']['error']===0){ $up_dir = __DIR__ . '/uploads'; if(!is_dir($up_dir)) mkdir($up_dir, 0755, true); $tmp = $_FILES['photo']['tmp_name']; $name = basename($_FILES['photo']['name']); $safe = uniqid().'_'.preg_replace('/[^a-zA-Z0-9._-]/','_', $name); $dest = $up_dir . '/' . $safe; if(move_uploaded_file($tmp, $dest)){ $is_primary = 0; $stmt = $pdo->prepare('SELECT COUNT(*) as c FROM photos WHERE user_id = ? AND is_primary = 1'); $stmt->execute([$user['id']]); $r = $stmt->fetch(); if(!$r || $r['c'] == 0) $is_primary = 1; $pdo->prepare('INSERT INTO photos (user_id, file_path, is_primary, uploaded_at) VALUES (?,?,?,NOW())')->execute([$user['id'], $safe, $is_primary]); $msg = 'Photo uploaded.'; } else { $msg = 'Upload failed.'; } } ?><?php include 'header.php'; ?><h1>Upload Photo</h1><?php if($msg) echo '<p style="color:green">'.htmlspecialchars($msg).'</p>'; ?><form method="post" enctype="multipart/form-data"><label>Select photo: <input type="file" name="photo" accept="image/*" required></label><br><button>Upload</button></form><p><a href="profile.php">Back to Profile</a></p><?php include 'footer.php'; ?>